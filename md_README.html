<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>BackgroundAudio: BackgroundAudio - Play MP3, AAC, WAV, and Speech on the Raspberry Pi Pico (RP2040), Pico 2 (RP2350), and ESP32</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">BackgroundAudio<span id="projectnumber">&#160;1.4.3</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">BackgroundAudio - Play MP3, AAC, WAV, and Speech on the Raspberry Pi Pico (RP2040), Pico 2 (RP2350), and ESP32</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md0"></a> BackgroundAudio is an Arduino library that lets sketches play MP3s, AACs, and WAVs on the Raspberry Pi Pico, Pico 2, and ESP32 with a very simple application level interface. Data is written to the playback object when available from the main application, and interrupts (IRQs) are used to generate data for I2S, PWMAudio, or Bluetooth A2DP in the background. The application only needs to provide data faster than it is decompressed. There is a source buffer that's managed by the playback routine, letting apps "fire and forget" for playback.</p>
<p>This is based off of <a href="https://github.com/earlephilhower/ESP8266Audio">ESP8266Audio</a> but is significantly simplified in terms of API and usage, as well as available options. This allows for a much more efficient use of the processor and a better playback experience in most cases. If you need the ultimate in control and capabilities, see <a href="https://github.com/earlephilhower/ESP8266Audio">ESP8266Audio</a>. If you just want to play back audio without blocking your main application, this library can help.</p>
<p>Because this library is much more optimized and efficient than ESP8266Audio, a standard Pico W can actually easily stream an MP3 web radio station using HTTPS encryption (the standard). A Pico 2 W can easily handle a HE-AAC web station under the same conditions, too, because of it's much higher IPC core and higher clock rate.</p>
<p>(As a point of comparison, the WebRadio example in the ESP8266Audio library is not very stable because the audio processing is happening in the same context as the web interface and net streaming code leading to dropouts and hangs in extended use. The WebRadioMP3PlusWebUI sketch here is basically the same user application but because of the interrupt-driver, buffer-based architecture playback is very smooth even on an original Pico and even with HTTPS decryption in software. The MP3 decoder and HTTPs encryption stack are the same in both libraries, they're just used more efficiently here.)</p>
<h1><a class="anchor" id="autotoc_md1"></a>
Online Documentation</h1>
<p>See <a href="https://earlephilhower.github.io/BackgroundAudio/">https://earlephilhower.github.io/BackgroundAudio/</a> for more class information, along with all the included examples.</p>
<h1><a class="anchor" id="autotoc_md2"></a>
Compatibility</h1>
<p>BackgroundAudio today builds and runs under <a href="https://github.com/earlephilhower/arduino-pico">Arduino-Pico</a>, and <a href="https://github.com/espressif/arduino-esp32">Arduino-ESP32</a>. It should be possible to port to any Arduino core which has I2S/audio packet callbacks to drive the processing.</p>
<h1><a class="anchor" id="autotoc_md3"></a>
Adding BackgroundAudio to an Application</h1>
<p>Simply include the appropriate header, or <code><a class="el" href="BackgroundAudio_8h_source.html">BackgroundAudio.h</a></code> for all codecs. Instantiate a global object of the appropriate type, passing in an output device (<code>I2S</code>, <code>PWMAudio</code>, or even <code>A2DPSink</code>) to the constructor. When the app is initialized, simply call <code>begin()</code> and start <code>write</code>ing in data as it is available.</p>
<p>Note that the app is responsible for feeding in data from whatever source to the decoder. The decoder itself, because it runs at interrupt level, cannot read the filesystem or network to collect samples (either operation could block which is not allowed at interrupt time). If all data can live in flash, there is a ROM-based playback object which <em>can</em> feed itself, but only from arrays in flash and not files in <code>LittleFS</code> or <code>SD</code>. See the examples for more details on this mode.</p>
<p>In the case of underflow the playback object will play silence and should recover when new data arrives. The built-in source (raw, uncompressed) buffer should help reduce this possibility.</p>
<div class="fragment"><div class="line">// Barnyard sounds for children sketch</div>
<div class="line">#include &lt;BackgroundAudio.h&gt;</div>
<div class="line">#include &lt;LittleFS.h&gt;</div>
<div class="line">...</div>
<div class="line">PWMAudio pwm(0);</div>
<div class="line">BackgroundAudioMP3 mp3(pwm);</div>
<div class="line">...</div>
<div class="line">void setup() {</div>
<div class="line">    LittleFS.begin();</div>
<div class="line">    mp3.begin();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">File f;</div>
<div class="line">void loop() {</div>
<div class="line">    // If there&#39;s a file open, stuff the playback buffer with it</div>
<div class="line">    while (f &amp;&amp; mp3.availableForWrite() &gt; 512) {</div>
<div class="line">        int len = f.read(filebuff, 512);</div>
<div class="line">        // Write whatever was read out.</div>
<div class="line">        // Even if we change files in the middle, the playback object will resynchronize automatically</div>
<div class="line">        mp3.write(filebuff, len);</div>
<div class="line">        if (len != 512) {</div>
<div class="line">            f.close(); // Short reads == EOF</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    ...</div>
<div class="line">    // Display UI, check buttons, etc.</div>
<div class="line">    ...</div>
<div class="line">    if (RoosterButtonPressed) {</div>
<div class="line">        f = LittleFS.open(&quot;cluck.mp3&quot;);</div>
<div class="line">    } else if (CowButtonPressed) {</div>
<div class="line">        f = LittleFS.open(&quot;moo.mp3&quot;);</div>
<div class="line">    } else ...</div>
<div class="line"> </div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md4"></a>
ESP32 Implementation</h1>
<p>The ESP32 support requires the use of the built-in I2S wrapper library and does not use (and is not compatible) with the <code>I2S</code> library distributed with <code>Arduino-ESP32</code>. Several additional features were required to port the background processing, and those are not available in the Arduino library. To instantiate the ESP32 I2S wrapper, copy the examples and use the following:</p>
<div class="fragment"><div class="line">#include &lt;ESP32I2SAudio.h&gt;</div>
<div class="line">ESP32I2SAudio audio(4, 5, 6); // BCLK, LRCLK, DOUT</div>
</div><!-- fragment --><p>The <code><a class="el" href="classESP32I2SAudio.html" title="I2S object with IRQ-based callbacks to a FreeRTOS task, for use with BackgroundAudio.">ESP32I2SAudio</a></code> object can be passed in to any of the BackgroundAudio constructors as it implements the <code>AudioOutputBase</code> class.</p>
<h1><a class="anchor" id="autotoc_md5"></a>
ESP32 and Platform.IO</h1>
<p>It seems that Espressif discontinued official Platform.IO integration of their Arduino several releases ago. The <code>platformio/framework-arduinoespressif32</code> package available is much older than the latest Espressif Arduino core and at IDF 4.x. This library needs IDF 5.x and the new I2S APIs to function, so if you attempt to build using <code>platformio/framework-arduinoespressif32</code> you will get errors like, <code>cannot open source file "driver/i2s_std.h"</code>.</p>
<p>The solution is to move to @Jason2866's community <a href="https://github.com/pioarduino/platform-espressif32">pioarduino</a> core which is built from the current Espressif Arduino with IDF 5.x. Simply change <code>platform</code> in your <code>platform.ini</code> as below:</p>
<div class="fragment"><div class="line">; Pioarduino Arduino-ESP32 3.2.0</div>
<div class="line">platform = https://github.com/pioarduino/platform-espressif32/releases/download/54.03.20/platform-espressif32.zip</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md6"></a>
Performance</h1>
<p>The SpeedTest example included provided allows for different optimization and CPUs to be tested. I recommend using <code>-O3</code> optimization mode, available in the IDE menus, as it can reduce CPU usage by a very large amount on the Pico. As is obvious from the numbers below, HE-AAC decoding is much more computationally intensive than simple AAC. (The original Pico can playback most normal AAC files without issue, but many web radio streamers use HE-AAC to minimize bandwidth.)</p>
<h2><a class="anchor" id="autotoc_md7"></a>
PICO 2, -O3  (ARM mode)</h2>
<div class="fragment"><div class="line">HE-AAC decode cycles: 112322331, frames 103, cycles/sample 1486.00</div>
<div class="line">AAC decode cycles: 112322331, frames 206, cycles/sample 532.47</div>
<div class="line">MP3 decode cycles: 111250252, frames 183, cycles/sample 527.71</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md8"></a>
PICO, -O3</h2>
<div class="fragment"><div class="line">HE-AAC decode cycles: 310594598, frames 103, cycles/sample 6390.67</div>
<div class="line">AAC decode cycles: 310594598, frames 206, cycles/sample 1472.40</div>
<div class="line">MP3 decode cycles: 201450592, frames 183, cycles/sample 955.58</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md9"></a>
Examples</h1>
<ul>
<li>BeepSpeech : Says "Beep Boop" every time the BOOTSEL is pressed. Demonstrates how the main app continues while speech is being generated, and how to stop a dictation in mid-stream.</li>
<li>BeepWAV : Plays "beep" using PWM to a phono jack every time the BOOTSEL button is pressed. Shows how the main app can continue doing work while playback is ongoing and how to start a new WAV file without needing to finish a currently playing one.</li>
<li>PlayAACROM : Plays an AAC piano sample over PWM every time a character comes in over Serial. Demonstrates the ROM playback objects and how they don't need any application interaction after they're fired off.</li>
<li>ReactionTimer : Simple game that measures how long it takes the user to respond to the LED lighting up, calculating and speaking the time on-the-fly.</li>
<li>SerialSpeak : You type, it talks! Allows changing between voices on-the-fly. Demonstrates the simple speech API and accessing the multiple predefined speech dictionaries and voices.</li>
<li>SimpleMP3Shuffle : Convert your Pico into an SD-card MP3 player. Continuously plays randomly selected MP3 files from the root folder of an attached SD card. Demonstrates how an application can send raw data to the decoder while still doing other processing.</li>
<li>SpeedTest : Calculates the number of CPU cycles per output sample for MP3, AAC, and HE-AAC using the current CPU and optimization settings. Useful to see how different <code>-Ox</code> settings change performance,</li>
<li>WebradioMP3PlusWebUI : Shows a more complete application that can play an MP3 web radio using HTTPS connectivity. Includes a serial and HTTP WebServer interface to allow the user to change URLs, volumes, and see the ICY metadata.</li>
</ul>
<h1><a class="anchor" id="autotoc_md10"></a>
Codec Licensing</h1>
<ul>
<li>AAC decode source is from the Helix project and licensed under RealNetwork's RSPL license. For commercial use you're still going to need the usual AAC licensing from <a href="http://www.via-corp.com/us/en/licensing/aac/overview.html">Via Licensing</a>.</li>
<li>MP3 decode source is from libMAD by Underbit Technologies, Inc., and licensed under the GPL.</li>
<li>ESpeak-NG is GPL3 licensed and available from the maintainers at <a href="https://github.com/espeak-ng/espeak-ng">https://github.com/espeak-ng/espeak-ng</a> </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8
</small></address>
</body>
</html>
